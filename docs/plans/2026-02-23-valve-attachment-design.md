# 仪表阀门台账管理系统 - 附件功能设计文档

**日期**: 2026-02-23

## 一、概述

本文档描述在新建/编辑台账界面中添加附件功能的实现方案。附件是指阀门的配套部件，如定位器、过滤减压阀、减压阀、电磁阀、接近开关等。

## 二、需求来源

根据设计文档 `2026-02-15-valve-ledger-system-design.md` 第12.3节要求：
- 新建台账第6步为"附件信息"
- 支持添加多个附件
- 附件类型：定位器、过滤减压阀、减压阀、电磁阀、接近开关等
- 提交前可无限添加

## 三、数据库设计

### 3.1 附件表 (valve_attachments)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键，自增 |
| valve_id | Integer | 外键，关联 valves 表 |
| 名称 | String(100) | 附件名称 |
| 设备等级 | String(20) | 设备等级 |
| 型号规格 | String(100) | 型号规格 |
| 生产厂家 | String(100) | 生产厂家 |
| type | String(50) | 附件类型 |
| created_at | DateTime | 创建时间 |

### 3.2 附件类型选项

- 定位器
- 过滤减压阀
- 减压阀
- 电磁阀
- 接近开关
- 其他

## 四、页面设计

### 4.1 第6步：附件信息

```
┌────────────────────────────────────────────────────────────────┐
│  附件信息                                                      │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 附件类型  │ 名称 │ 设备等级 │ 型号规格 │ 生产厂家 │    │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ [定位器▼] │      │          │          │          │ ✕  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ [过滤减压阀▼]│     │          │          │          │ ✕  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│                          [+ 添加附件]                          │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 4.2 设计要点

1. **动态添加**：点击"添加附件"按钮新增一行
2. **动态删除**：每行有删除按钮
3. **类型下拉**：预设附件类型选项
4. **提交保存**：与台账数据同一事务保存

## 五、后端设计

### 5.1 数据模型

新增 `ValveAttachment` 模型类，包含以下字段：
- id: 主键
- valve_id: 外键
- 名称: 附件名称
- 设备等级: 设备等级
- 型号规格: 型号规格
- 生产厂家: 生产厂家
- type: 附件类型
- created_at: 创建时间

### 5.2 表单提交

修改 `/valve/new` 和 `/valve/edit/<id>` 路由：
1. 解析表单中的附件数据（JSON格式或重复字段）
2. 创建 ValveAttachment 记录
3. 与 Valve 记录同一事务保存

### 5.3 数据格式

前端通过隐藏字段传递附件数据：
```html
<input type="hidden" name="attachments" value='[{"type":"定位器","名称":"xxx",...}]'>
```

## 六、编辑页面兼容性

编辑已有台账时：
1. 加载台账时查询关联的附件列表
2. 页面初始化时显示已有附件
3. 支持新增、删除、修改附件
4. 删除整个附件行时，提交后同步删除数据库记录

## 七、验证要点

1. 新建台账可添加多个附件
2. 附件数据与台账一起保存
3. 位号唯一性检查仍然有效
4. 编辑页面可加载已有附件
5. 删除附件行后提交，数据库记录同步删除
