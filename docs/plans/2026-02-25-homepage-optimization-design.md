# 仪表阀门台账管理系统 - 首页优化设计

## 1. 需求背景

当前首页展示的是以单条台账记录为单位的统计数据，需要优化为以"台账合集"为单位进行展示。

## 2. 优化目标

| 模块 | 现状 | 优化后 |
|------|------|--------|
| 我的台账 | 显示用户创建的台账记录数量 | 显示用户台账合集数量 + 记录总数，点击跳转到用户台账合集列表 |
| 全部台账 | 显示台账记录总数 | 显示台账合集数量 + 记录总数，点击跳转到台账合集界面 |
| 我的申请 | 显示待审批记录数（以内容为单位） | 显示审批提交数量（以合集为单位），点击跳转到合集级审批界面 |

## 3. 详细设计

### 3.1 首页卡片变更

#### 我的台账（普通员工和管理员）
- 显示：用户拥有的台账合集数量 + 记录总数
- 格式：例如 "3 个合集，共 45 条记录"
- 跳转：新建页面 `/my-ledgers`

#### 全部台账（普通员工和管理员）
- 显示：系统台账合集数量 + 记录总数
- 格式：例如 "5 个合集，共 120 条记录"
- 跳转：复用现有 `/ledgers` 页面

#### 我的申请（普通员工）
- 显示：用户提交的待审批合集数量
- 格式：例如 "2 个待审批"
- 跳转：新建页面 `/my-ledger-applications`

#### 待审批（管理员/领导）
- 显示：所有待审批的合集数量
- 格式：例如 "2 个待审批"
- 跳转：新建页面 `/ledger-approvals`

### 3.2 新建页面设计

#### 3.2.1 我的台账合集列表 `/my-ledgers`

显示当前用户拥有的所有台账合集，参考现有 `/ledgers` 页面设计，按创建者筛选。

**路由**：`@valves.route("/my-ledgers")`

**逻辑**：
- 查询 `Ledger.created_by == current_user.id`
- 计算每个合集中的记录数

#### 3.2.2 我的审批申请 `/my-ledger-applications`

显示用户提交的需要审批的台账合集，以合集为单位展示。

**路由**：`@valves.route("/my-ledger-applications")`

**逻辑**：
- 查询用户创建的 Ledger 中包含 pending 状态 Valve 的合集
- 按合集显示，显示每个合集的待审批数量

### 3.3 数据统计逻辑

```
我的台账:
  - 合集数 = Ledger.query.filter_by(created_by=current_user.id).count()
  - 记录数 = Valve.query.join(Ledger).filter(Ledger.created_by == current_user.id).count()

全部台账:
  - 合集数 = Ledger.query.count()
  - 记录数 = Valve.query.count()

我的申请:
  - 待审批合集数 = 用户创建的Ledger中包含pending状态Valve的合集数量
```

## 4. 涉及的代码修改

| 文件 | 修改内容 |
|------|----------|
| `app/routes/__init__.py` | 修改首页数据获取逻辑 |
| `templates/index.html` | 修改卡片样式和数据展示 |
| `app/routes/valves.py` | 新增 `/my-ledgers` 和 `/my-ledger-applications` 路由 |

## 5. 验收标准

1. 首页"我的台账"正确显示用户台账合集数量和记录总数
2. 首页"全部台账"正确显示系统台账合集数量和记录总数
3. 点击"我的台账"跳转到用户台账合集列表页面
4. 点击"全部台账"跳转到台账合集界面（/ledgers）
5. 首页"我的申请"正确显示用户提交的待审批合集数量
6. 点击"我的申请"跳转到合集级审批界面
7. 新增页面功能正常，样式与现有页面一致
