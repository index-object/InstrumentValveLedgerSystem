# 仪表阀门台账管理系统 - 设计文档

**日期**: 2026-02-15

**最后更新**: 2026-02-18

## 一、项目概述

仪表阀门台账管理系统是一个用于企业员工和领导共同管理仪表阀门数据的 Web 应用。系统支持基本的增删改查功能，包含审批工作流、数据导入导出、照片管理、维护记录等完整功能。

## 二、技术栈

| 技术 | 说明 |
|------|------|
| 后端 | Flask 3.x (Python) |
| 数据库 | SQLite |
| 前端 | Bootstrap 5 + Jinja2 模板 |
| Excel 处理 | pandas + openpyxl |
| PDF 导出 | WeasyPrint |

## 三、用户角色

| 角色 | 权限 |
|------|------|
| 员工 | 录入台账、提交申请、查看所有数据、维护记录、照片管理 |
| 领导 | 审批（可选）、查看所有数据、管理后台、导入导出 |
| 管理员 | 全部权限、用户管理、系统设置 |

## 四、审批流程（可配置）

```python
# 系统设置
auto_approval = True  # 默认自动审批模式
```

- **自动审批模式 (auto_approval=True)**: 员工提交 → 系统自动通过 → 立即生效
- **手动审批模式 (auto_approval=False)**: 员工提交 → 领导审批 → 通过/驳回
- **领导可开关**: 领导可以在系统设置中切换自动审批/手动审批模式

## 五、数据可见性

| 角色 | 可见范围 |
|------|---------|
| 员工 | 可查看所有数据（包括待审批），但只能编辑自己提交的台账 |
| 领导 | 可查看、编辑所有数据 |
| 管理员 | 可查看、编辑所有数据 |

## 六、数据库设计

### 6.1 users (用户表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| username | String(50) | 用户名（唯一） |
| password_hash | String(200) | 密码哈希 |
| role | String(20) | 角色：employee / leader / admin |
| real_name | String(50) | 真实姓名 |
| dept | String(50) | 部门 |
| status | String(20) | 状态：active / inactive |
| created_at | DateTime | 创建时间 |

### 6.2 valves (仪表阀门台账)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| 序号 | String(20) | 序号 |
| 装置名称 | String(100) | 装置名称 |
| 位号 | String(50) | 位号（唯一标识） |
| 名称 | String(100) | 设备名称 |
| 设备等级 | String(20) | 设备等级 |
| 型号规格 | String(100) | 型号规格 |
| 生产厂家 | String(100) | 生产厂家 |
| 安装位置及用途 | String(200) | 安装位置 |
| 工艺条件_介质名称 | String(50) | 介质名称 |
| 工艺条件_设计温度 | String(50) | 设计温度℃ |
| 工艺条件_阀前压力 | String(50) | 阀前压力MPa |
| 工艺条件_阀后压力 | String(50) | 阀后压力MPa |
| 阀体_公称通径 | String(50) | 公称通径 |
| 阀体_连接方式及规格 | String(100) | 连接方式及规格 |
| 阀体_材质 | String(50) | 阀体材质 |
| 阀内件_阀座直径 | String(50) | 阀座直径 |
| 阀内件_阀芯材质 | String(50) | 阀芯材质 |
| 阀内件_阀座材质 | String(50) | 阀座材质 |
| 阀内件_阀杆材质 | String(50) | 阀杆材质 |
| 阀内件_流量特性 | String(50) | 流量特性 |
| 阀内件_泄露等级 | String(50) | 泄露等级 |
| 阀内件_Cv值 | String(50) | Cv值 |
| 执行机构_形式 | String(50) | 执行机构形式 |
| 执行机构_型号规格 | String(100) | 型号规格 |
| 执行机构_厂家 | String(100) | 生产厂家 |
| 执行机构_作用形式 | String(50) | 作用形式 |
| 执行机构_行程 | String(50) | 行程 |
| 执行机构_弹簧范围 | String(50) | 弹簧范围 |
| 执行机构_气源压力 | String(50) | 气源压力 |
| 执行机构_故障位置 | String(50) | 故障位置 |
| 执行机构_关阀时间 | String(50) | 关阀时间 |
| 执行机构_开阀时间 | String(50) | 开阀时间 |
| 设备编号 | String(50) | 设备编号 |
| 是否联锁 | String(10) | 是否联锁 |
| 备注 | Text | 备注 |
| status | String(20) | 状态：draft/pending/approved/rejected |
| created_by | Integer | 创建人ID |
| approved_by | Integer | 审批人ID |
| approved_at | DateTime | 审批时间 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 6.3 valve_photos (照片表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| valve_id | Integer | 外键关联 valves |
| filename | String(200) | 文件名 |
| description | String(200) | 描述 |
| uploaded_by | Integer | 上传人ID |
| uploaded_at | DateTime | 上传时间 |

### 6.4 maintenance_records (维护记录)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| valve_id | Integer | 外键关联 valves |
| 类型 | String(50) | 维护类型（自定义） |
| 日期 | Date | 维护日期 |
| 内容 | Text | 维护内容 |
| 负责人 | String(50) | 负责人 |
| created_by | Integer | 记录人ID |
| created_at | DateTime | 创建时间 |

### 6.5 approval_logs (审批日志)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| valve_id | Integer | 外键关联 valves |
| action | String(20) | submit/approve/reject |
| user_id | Integer | 操作人ID |
| comment | String(500) | 备注 |
| timestamp | DateTime | 操作时间 |

### 6.6 settings (系统设置)

| 字段 | 类型 | 说明 |
|------|------|------|
| key | String(50) | 设置键 |
| value | String(200) | 设置值 |

## 七、页面结构

| 路由 | 页面 | 说明 |
|------|------|------|
| `/` | 首页/工作台 | 统计卡片、快捷入口 |
| `/login` | 登录 | 用户登录 |
| `/logout` | 登出 | 退出登录 |
| `/valves` | 台账列表 | 搜索、筛选、导出、批量操作 |
| `/valve/<id>` | 台账详情 | 查看完整信息、照片、历史 |
| `/valve/new` | 录入申请 | 填写台账信息 |
| `/valve/edit/<id>` | 编辑台账 | 编辑草稿状态的数据 |
| `/valve/delete/<id>` | 删除台账 | 逻辑删除 |
| `/approvals` | 审批管理 | 手动模式下领导审批 |
| `/import` | Excel导入 | 批量导入台账数据（覆盖模式） |
| `/export` | 数据导出 | 导出Excel |
| `/valve/<id>/photos` | 照片管理 | 上传/查看照片 |
| `/valve/<id>/maintenance` | 维护记录 | 添加维护记录 |
| `/maintenance` | 维护记录列表 | 查看所有维护记录 |
| `/admin` | 后台管理 | 跳转页面 |
| `/admin/users` | 用户管理 | 添加/编辑/禁用/删除用户 |
| `/admin/settings` | 系统设置 | 配置自动审批等 |

## 八、核心功能说明

### 7.1 审批工作流

1. **自动审批模式** (默认)
   - 员工提交申请后，系统自动审批通过
   - 台账状态：draft → approved

2. **手动审批模式**
   - 员工提交申请后，台账状态：draft → pending
   - 领导审批：pending → approved / rejected
   - 被驳回后，员工可修改重新提交
   - 审批成功后在审批详情卡片显示小红点通知

3. **领导开关**
   - 领导可在系统设置中切换自动审批/手动审批模式

### 7.2 Excel 导入

- 读取 Excel 文件，解析台账数据
- 覆盖模式：位号已存在则更新，不存在则新增
- 导入数据无需审批，直接生效
- 仅领导/管理员可导入

### 7.3 数据导出

- **Excel 导出**: 使用 pandas 导出完整台账
- 支持批量导出

### 7.4 照片管理

- 支持上传仪表设备照片
- 照片与台账关联存储
- 详情页展示照片列表
- 上传后直接生效，无需审批
- 任何人可上传

### 7.5 维护记录

- 支持自定义维护类型
- 任何人可添加维护记录
- 记录与台账关联存储

### 7.6 批量操作

- 批量导出：勾选多条记录，导出Excel
- 批量删除：勾选多条记录，逻辑删除
- 批量审批：勾选多条记录，批量审批通过（仅领导）
- 支持全选/反选
- 选中记录后显示批量操作工具栏

### 7.7 用户管理

- 管理员可添加、编辑、禁用、删除用户
- 管理员可重置用户密码
- 初始密码：123456，用户首次登录后强制修改

### 7.8 编辑权限

- 创建人 + 领导可编辑台账
- 修改后自动审批（如果是自动审批模式）

## 九、首页工作台设计

### 9.1 员工界面

| 卡片 | 显示内容 | 功能 |
|------|---------|------|
| 我的台账 | 该用户维护的台账数量 | 点击进入该用户维护的台账列表 |
| 全部台账 | 所有台账总数 + 所有设备总数 | 点击进入全部台账列表 |
| 审批详情 | 待审批数量（有待处理时显示小红点） | 点击进入审批页面 |
| 检修记录 | 检修记录总数 | 点击进入维护记录列表 |

### 9.2 领导界面

| 卡片 | 显示内容 | 功能 |
|------|---------|------|
| 审批详情 | 待审批数量 | 点击进入审批页面 |
| 全部台账 | 台账总数 | 点击进入台账列表 |
| 统计卡片 | 总用户数 | 点击展开显示用户名和各自创建的台账数量 |

### 9.3 布局

- 整体使用网格布局
- 每个功能占用一个大卡片样式
- 卡片右上角可显示消息小红点用于通知

## 十、台账列表页面设计

| 功能 | 设计 |
|------|------|
| **显示方式** | 表格控件，显示所有字段，带滚动条 |
| **每页数量** | 20条 |
| **筛选** | 快速筛选（常用字段）+ 高级筛选（所有字段） |
| **搜索** | 支持全文搜索（所有字段） |
| **批量操作** | 导出、删除、审批，全选/反选，选中后显示工具栏 |
| **导入/导出按钮** | 放在批量操作工具栏内 |

## 十一、台账详情页设计

| 功能 | 设计 |
|------|------|
| **信息展示** | 卡片分组展示 |
| **分组方式** | 基础信息 → 附件区域 → 工艺条件 → 阀体信息 → 阀内件信息 → 执行机构信息 |
| **显示方式** | 表格形式，字段名前加小图标，名称高亮 |
| **附件显示** | 卡片部件形式，展示在基础信息和工艺条件之间 |
| **维护记录** | 显示在页面最下方 |
| **操作按钮** | 编辑、删除、添加维护记录、返回 |

### 11.1 分组字段

| 分组 | 包含字段 |
|------|---------|
| **基础信息** | 序号、位号、名称、装置名称、设备等级、型号规格、生产厂家、安装位置及用途、设备编号、是否联锁、备注 |
| **附件区域** | 定位器、过滤减压阀、减压阀、电磁阀、接近开关等（卡片部件形式） |
| **工艺条件** | 介质名称、设计温度、阀前压力、阀后压力 |
| **阀体信息** | 公称通径、连接方式及规格、阀体材质、阀座序列号 |
| **阀内件信息** | 阀芯材质、阀杆材质、流量特性、泄露等级 |
| **执行机构信息** | Cv值、形式、型号规格、厂家、作用形式、行程、弹簧范围、气源压力、故障位置、关阀时间、开阀时间 |

## 十二、新建/编辑页面设计

### 12.1 新建页面 - 分步表单

| 步骤 | 内容 |
|------|------|
| 第1步 | 基础信息 |
| 第2步 | 工艺条件 |
| 第3步 | 阀体信息 |
| 第4步 | 阀内件信息 |
| 第5步 | 执行机构信息 |
| 第6步 | 附件信息（可添加多个：定位器、过滤减压阀、减压阀、电磁阀、接近开关等） |

### 12.2 新建页面 - 详细设计

| 功能 | 设计 |
|------|------|
| **导航方式** | 顶部进度条 + 底部上一步/下一步按钮 |
| **附件添加** | 每行填写一个，提交前可无限添加 |
| **必填字段** | 基础信息中的位号、名称、装置名称 |
| **字段验证** | 位号唯一性检查，冲突时提示具体装置和位号 |
| **草稿保存** | 自动保存，提交后清除 |

### 12.3 编辑页面 - 单页表单

- 与详情页样式一致
- 表格形式展示各分组信息
- 可直接编辑各字段
- 可添加/删除/编辑附件

### 12.3 附件表设计

新增附件表，用于存储阀门的附件信息（定位器、过滤减压阀、减压阀、电磁阀、接近开关等）。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| valve_id | Integer | 外键关联 valves |
| 名称 | String(100) | 附件名称 |
| 设备等级 | String(20) | 设备等级 |
| 型号规格 | String(100) | 型号规格 |
| 生产厂家 | String(100) | 生产厂家 |
| type | String(50) | 附件类型 |
| created_at | DateTime | 创建时间 |

## 十二、审批详情页面设计

### 12.1 列表页面

| 功能 | 设计 |
|------|------|
| **显示方式** | 三个TAB切换：待审批 / 已审批 / 已驳回 |
| **每条记录** | 显示总条数、申请人、申请时间、状态 |
| **点击操作** | 点击后跳转到审批界面 |

### 12.2 审批界面

| 功能 | 设计 |
|------|------|
| **标题** | 显示审批数量、审批人、审批时间 |
| **列表** | 参考台账列表页面，显示所有字段 |
| **操作按钮** | 批量通过、批量驳回 |
| **备注** | 审批时可填写备注/意见 |
| **单条操作** | 每行显示通过、驳回按钮 |

## 十三、维护记录列表页面设计

### 13.1 维护记录表设计

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| valve_id | Integer | 外键关联 valves |
| 所属中心 | String(100) | 必填 |
| 设备位号 | String(50) | 必填（关联valve） |
| 设备名称 | String(100) | 关联valve |
| 检修时间 | DateTime | 必填 |
| 检修内容 | Text | 检修内容 |
| 检修人员 | String(50) | 检修人员 |
| created_by | Integer | 记录人ID |
| created_at | DateTime | 创建时间 |

### 13.2 列表页面

| 功能 | 设计 |
|------|------|
| **显示方式** | 表格形式 |
| **显示字段** | 设备位号、设备名称、所属中心、检修时间、检修人员、检修内容（前15字） |
| **筛选** | 全字段可筛选（除系统字段和检修内容） |
| **搜索** | 支持搜索检修内容 |
| **导出** | 导出Excel |
| **添加** | 添加维护记录按钮 |
| **批量操作** | 批量导出、批量删除 |

## 十四、安全性

- 密码使用 bcrypt 哈希存储
- 登录会话使用 Flask-Login 管理
- 路由权限检查装饰器
- 文件上传路径限制和验证
