{% extends "base.html" %}

{% block page_title %}
<span style="display: flex; align-items: center; gap: 8px;">
    <i class="bi bi-check-circle-fill" style="color: #10b981;"></i>
    审批中心
</span>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ledgers-list.css') }}">
{% endblock %}

{% block header_actions %}
<div class="toolbar">
    <div class="search-filter">
        <a href="{{ url_for('approvals.index', tab='pending') }}" class="btn-tab {% if tab=='pending' %}active{% endif %}">
            <span class="badge-count">{{ pending_count }}</span>
            待审批
        </a>
        <a href="{{ url_for('approvals.index', tab='approved') }}" class="btn-tab {% if tab=='approved' %}active{% endif %}">
            已审批
        </a>
        <a href="{{ url_for('approvals.index', tab='rejected') }}" class="btn-tab {% if tab=='rejected' %}active{% endif %}">
            已驳回
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<style>
.btn-tab {
    padding: 8px 16px;
    border-radius: 6px;
    color: #6b7280;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.btn-tab:hover {
    background: #f3f4f6;
    color: #374151;
}
.btn-tab.active {
    background: #ecfdf5;
    color: #059669;
    border: 1px solid #a7f3d0;
}
.badge-count {
    background: #ef4444;
    color: white;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
}
.badge-status {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}
.badge-pending {
    background: #fef3c7;
    color: #d97706;
}
.badge-approved {
    background: #d1fae5;
    color: #059669;
}
.badge-rejected {
    background: #fee2e2;
    color: #dc2626;
}
.badge-draft {
    background: #f3f4f6;
    color: #6b7280;
}
</style>

<div class="modern-card">
    <form method="POST" id="approvalForm">
        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 25%;">合集名称</th>
                        <th style="width: 10%;">台账总数</th>
                        <th style="width: 10%;">待审批</th>
                        <th style="width: 10%;">已审批</th>
                        <th style="width: 10%;">已驳回</th>
                        <th style="width: 15%;">创建人</th>
                        <th style="width: 15%;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ledger in ledgers %}
                    <tr>
                        <td>
                            {% if tab == 'pending' %}
                            <input type="checkbox" name="ledger_ids" value="{{ ledger.id }}" class="ledger-checkbox">
                            {% else %}
                            <input type="checkbox" disabled title="该合集无待审批项">
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('ledgers.detail', id=ledger.id) }}" class="ledger-name-link">
                                <i class="bi bi-folder2 folder-icon" style="color: #3b82f6;"></i>{{ ledger.名称 }}
                            </a>
                        </td>
                        <td><span style="font-weight: 600; color: var(--text-dark);">{{ ledger.valve_count }}</span> 条</td>
                        <td>
                            {% if ledger.pending_count > 0 %}
                            <span class="badge-status badge-pending">{{ ledger.pending_count }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if ledger.approved_count > 0 %}
                            <span class="badge-status badge-approved">{{ ledger.approved_count }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if ledger.rejected_count > 0 %}
                            <span class="badge-status badge-rejected">{{ ledger.rejected_count }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ ledger.creator.real_name if ledger.creator else '-' }}</td>
                        <td>
                            <a href="{{ url_for('ledgers.detail', id=ledger.id) }}" class="btn-action btn-view">
                                <i class="bi bi-eye"></i> 查看
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-5">
                            <i class="bi bi-inbox" style="font-size: 48px; opacity: 0.3;"></i>
                            <p class="mt-2">暂无数据</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if ledgers and tab == 'pending' %}
        <div class="table-footer">
            <div class="footer-left">
                <button type="button" class="btn btn-success" onclick="showApproveModal()">
                    <i class="bi bi-check-circle"></i> 批量审批
                </button>
                <button type="button" class="btn btn-danger" onclick="showRejectModal()">
                    <i class="bi bi-x-circle"></i> 批量驳回
                </button>
            </div>
        </div>
        {% endif %}
    </form>
</div>

<!-- 审批确认弹窗 -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">批量审批确认</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确认审批选中的台账合集？</p>
                <div class="mb-3">
                    <label class="form-label">审批意见（可选）</label>
                    <textarea name="comment" class="form-control" rows="3" placeholder="请输入审批意见..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" form="approvalForm" formaction="{{ url_for('approvals.batch_approve') }}" class="btn btn-success">确认审批</button>
            </div>
        </div>
    </div>
</div>

<!-- 驳回确认弹窗 -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">批量驳回确认</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确认驳回选中的台账合集？</p>
                <div class="mb-3">
                    <label class="form-label">驳回原因（必填）</label>
                    <textarea name="comment" class="form-control" rows="3" placeholder="请输入驳回原因..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" form="approvalForm" formaction="{{ url_for('approvals.batch_reject') }}" class="btn btn-danger">确认驳回</button>
            </div>
        </div>
    </div>
</div>

<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.ledger-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

function showApproveModal() {
    const checked = document.querySelectorAll('.ledger-checkbox:checked');
    if (checked.length === 0) {
        alert('请选择要审批的合集');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('approveModal'));
    modal.show();
}

function showRejectModal() {
    const checked = document.querySelectorAll('.ledger-checkbox:checked');
    if (checked.length === 0) {
        alert('请选择要驳回的合集');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
    modal.show();
}
</script>
{% endblock %}
