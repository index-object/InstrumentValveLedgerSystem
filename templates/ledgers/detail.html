{% extends "valves/list.html" %}

{% block content %}
<div class="modern-card mb-3">
    <div class="p-3" style="border-bottom: 1px solid var(--border-color);">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted">状态：</span>
                {% if ledger.display_status == 'approved' %}
                <span class="badge-status badge-approved">已审批</span>
                {% elif ledger.display_status == 'pending' %}
                <span class="badge-status badge-pending">待审批</span>
                {% elif ledger.display_status == 'rejected' %}
                <span class="badge-status badge-rejected">已驳回</span>
                {% else %}
                <span class="badge-status badge-draft">草稿</span>
                {% endif %}
                <span class="text-muted ms-3">台账数量：{{ valves|length }}</span>
                <span class="text-muted ms-3">待审批：{{ ledger.pending_count }}</span>
            </div>
            {% if ledger.created_by == current_user.id or current_user.role in ['leader', 'admin'] %}
            <div class="d-flex gap-2">
                {% if ledger.display_status != 'approved' and ledger.draft_count > 0 %}
                <form method="post" action="{{ url_for('ledgers.submit', id=ledger.id) }}" style="display:inline;" onsubmit="return handleFormSubmit(this)">
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="bi bi-send"></i> 提交审批
                    </button>
                </form>
                {% endif %}
                {% if current_user.role in ['leader', 'admin'] and ledger.display_status == 'pending' %}
                <form method="post" action="{{ url_for('ledgers.approve', id=ledger.id) }}" style="display:inline;" onsubmit="return handleFormSubmit(this)">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg"></i> 批量审批
                    </button>
                </form>
                <form method="post" action="{{ url_for('ledgers.reject', id=ledger.id) }}" style="display:inline;" onsubmit="return handleFormSubmit(this)">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-x-lg"></i> 批量驳回
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<form method="post" id="valveForm">
    <input type="hidden" name="action" id="actionInput" value="">
    <input type="hidden" name="comment" id="commentInput" value="">
    
    <div class="modern-card mb-3">
        <div class="d-flex justify-content-between align-items-center p-3" style="border-bottom: 1px solid var(--border-color);">
            <div class="d-flex align-items-center gap-3">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="selectAll">
                </div>
                <span style="font-size: 14px;">已选 <span id="selectedCount">0</span> 项</span>
                {% if current_user.role in ['leader', 'admin'] and ledger.status == 'pending' %}
                <button type="button" class="btn btn-sm btn-success" onclick="submitBatchAction('batch_approve')">
                    <i class="bi bi-check-lg"></i> 批量审批
                </button>
                <button type="button" class="btn btn-sm btn-danger" onclick="submitBatchAction('batch_reject')">
                    <i class="bi bi-x-lg"></i> 批量驳回
                </button>
                {% endif %}
            </div>
            {% if ledger.created_by == current_user.id or current_user.role in ['leader', 'admin'] %}
            <a href="{{ url_for('ledgers.new_valve', id=ledger.id, from=request.args.get('from', 'all')) }}" class="btn btn-accent">
                <i class="bi bi-plus-lg"></i> 新增台账
            </a>
            {% endif %}
        </div>
    </div>

    <div class="modern-card">
        <div class="table-responsive" style="max-height: calc(100vh - 340px); overflow-y: auto; overflow-x: auto;">
            <table class="modern-table table-sm table-bordered" style="min-width: 1600px; border-spacing: 0;">
                <thead class="table-light">
                    <tr>
                        <th style="width: 50px; min-width: 50px; vertical-align: middle; position: sticky; left: 0; z-index: 3; background: #f8f9fa; border-right: 1px solid #dee2e6;">
                            <input type="checkbox" class="form-check-input" id="selectAllTop">
                        </th>
                        <th colspan="8" class="text-center table-secondary">基础信息</th>
                        <th colspan="4" class="text-center table-info">工艺条件</th>
                        <th colspan="3" class="text-center table-warning">阀体信息</th>
                        <th colspan="7" class="text-center table-danger">阀内件信息</th>
                        <th colspan="10" class="text-center table-success">执行机构信息</th>
                        <th colspan="2" class="text-center" style="background: #f8f9fa;">操作列</th>
                    </tr>
                    <tr>
                        <th style="width: 50px; min-width: 50px; position: sticky; left: 0; z-index: 3; background: #f8f9fa; border-right: 1px solid #dee2e6;"></th>
                        {% set fields = [
                            ('位号', '位号', 100), ('名称', '名称', 120), ('装置名称', '装置名称', 100),
                            ('设备等级', '设备等级', 70), ('型号规格', '型号规格', 100), ('生产厂家', '生产厂家', 100),
                            ('安装位置及用途', '安装位置', 120),
                            ('工艺条件_介质名称', '介质名称', 80), ('工艺条件_设计温度', '设计温度', 80),
                            ('工艺条件_阀前压力', '阀前压力', 80), ('工艺条件_阀后压力', '阀后压力', 80),
                            ('阀体_公称通径', '公称通径', 80), ('阀体_连接方式及规格', '连接方式', 100), ('阀体_材质', '阀体材质', 80),
                            ('阀内件_阀座直径', '阀座直径', 80), ('阀内件_阀芯材质', '阀芯材质', 80),
                            ('阀内件_阀座材质', '阀座材质', 80), ('阀内件_阀杆材质', '阀杆材质', 80),
                            ('阀内件_流量特性', '流量特性', 80), ('阀内件_泄露等级', '泄露等级', 80), ('阀内件_Cv值', 'Cv值', 60),
                            ('执行机构_形式', '形式', 80), ('执行机构_型号规格', '型号规格', 100), ('执行机构_厂家', '厂家', 80),
                            ('执行机构_作用形式', '作用形式', 80), ('执行机构_行程', '行程', 60),
                            ('执行机构_弹簧范围', '弹簧范围', 80), ('执行机构_气源压力', '气源压力', 80),
                            ('执行机构_故障位置', '故障位置', 80), ('执行机构_关阀时间', '关阀时间', 70), ('执行机构_开阀时间', '开阀时间', 70),
                            ('状态', '状态', 100), ('操作', '操作', 100)
                        ] %}
                        {% for field, label, width in fields %}
                        <th style="min-width: {{ width }}px;">{{ label }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for valve in valves %}
                    <tr>
                        <td style="position: sticky; left: 0; z-index: 2; background: #fff; border-right: 1px solid #dee2e6;">
                            <input type="checkbox" name="valve_ids" value="{{ valve.id }}" class="form-check-input item-checkbox">
                        </td>
                        <td>{{ loop.index }}</td>
                        <td><a href="{{ url_for('ledgers.valve_detail', ledger_id=ledger.id, id=valve.id) }}?from={{ request.args.get('from', 'all') }}" style="color: var(--primary-color); font-weight: 500;">{{ valve.位号 }}</a></td>
                        <td>{{ valve.名称 or '-' }}</td>
                        <td>{{ valve.装置名称 or '-' }}</td>
                        <td>{{ valve.设备等级 or '-' }}</td>
                        <td>{{ valve.型号规格 or '-' }}</td>
                        <td>{{ valve.生产厂家 or '-' }}</td>
                        <td>{{ valve.安装位置及用途 or '-' }}</td>
                        <td>{{ valve.工艺条件_介质名称 or '-' }}</td>
                        <td>{{ valve.工艺条件_设计温度 or '-' }}</td>
                        <td>{{ valve.工艺条件_阀前压力 or '-' }}</td>
                        <td>{{ valve.工艺条件_阀后压力 or '-' }}</td>
                        <td>{{ valve.阀体_公称通径 or '-' }}</td>
                        <td>{{ valve.阀体_连接方式及规格 or '-' }}</td>
                        <td>{{ valve.阀体_材质 or '-' }}</td>
                        <td>{{ valve.阀内件_阀座直径 or '-' }}</td>
                        <td>{{ valve.阀内件_阀芯材质 or '-' }}</td>
                        <td>{{ valve.阀内件_阀座材质 or '-' }}</td>
                        <td>{{ valve.阀内件_阀杆材质 or '-' }}</td>
                        <td>{{ valve.阀内件_流量特性 or '-' }}</td>
                        <td>{{ valve.阀内件_泄露等级 or '-' }}</td>
                        <td>{{ valve.阀内件_Cv值 or '-' }}</td>
                        <td>{{ valve.执行机构_形式 or '-' }}</td>
                        <td>{{ valve.执行机构_型号规格 or '-' }}</td>
                        <td>{{ valve.执行机构_厂家 or '-' }}</td>
                        <td>{{ valve.执行机构_作用形式 or '-' }}</td>
                        <td>{{ valve.执行机构_行程 or '-' }}</td>
                        <td>{{ valve.执行机构_弹簧范围 or '-' }}</td>
                        <td>{{ valve.执行机构_气源压力 or '-' }}</td>
                        <td>{{ valve.执行机构_故障位置 or '-' }}</td>
                        <td>{{ valve.执行机构_关阀时间 or '-' }}</td>
                        <td>{{ valve.执行机构_开阀时间 or '-' }}</td>
                        <td>
                            {% if valve.status == 'approved' %}
                            <span class="badge-status badge-approved">已审批</span>
                            {% elif valve.status == 'pending' %}
                            <span class="badge-status badge-pending">待审批</span>
                            {% elif valve.status == 'rejected' %}
                            <span class="badge-status badge-rejected">已驳回</span>
                            {% else %}
                            <span class="badge-status badge-draft">草稿</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('ledgers.valve_detail', ledger_id=ledger.id, id=valve.id) }}?from={{ request.args.get('from', 'all') }}" class="btn-action" style="background: #e2e8f0; color: #475569;">
                                <i class="bi bi-eye"></i>
                            </a>
                            {% if ledger.created_by == current_user.id or current_user.role in ['leader', 'admin'] %}
                            {% if valve.status in ['draft', 'rejected', 'approved'] %}
                            <a href="{{ url_for('ledgers.edit_valve', ledger_id=ledger.id, id=valve.id) }}" class="btn-action" style="background: rgba(56,178,172,0.1); color: var(--accent-color);">
                                <i class="bi bi-pencil"></i>
                            </a>
                            {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="34">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>暂无台账内容</p>
                                {% if ledger.created_by == current_user.id or current_user.role in ['leader', 'admin'] %}
                                <a href="{{ url_for('ledgers.new_valve', id=ledger.id, from=request.args.get('from', 'all')) }}" class="btn btn-accent">添加第一个台账</a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if pagination and pagination.pages > 1 %}
        <div class="p-3 border-top">
            <nav>
                <ul class="pagination-custom pagination mb-2">
                    {% if pagination.has_prev %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('ledgers.detail', id=ledger.id, page=pagination.prev_num, from=request.args.get('from', 'all')) }}">上一页</a></li>
                    {% endif %}
                    {% for p in range(1, pagination.pages + 1) %}
                    <li class="page-item {% if p == pagination.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('ledgers.detail', id=ledger.id, page=p, from=request.args.get('from', 'all')) }}">{{ p }}</a>
                    </li>
                    {% endfor %}
                    {% if pagination.has_next %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('ledgers.detail', id=ledger.id, page=pagination.next_num, from=request.args.get('from', 'all')) }}">下一页</a></li>
                    {% endif %}
                </ul>
            </nav>
            <small class="text-muted">共 {{ pagination.total }} 条记录</small>
        </div>
        {% endif %}
    </div>
</form>

<script>
function handleFormSubmit(form) {
    if (form.action.includes('reject') && !confirm('确定要驳回所有待审批的台账内容吗？')) {
        return false;
    }
    fetch(form.action, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new FormData(form)
    }).then(response => {
        window.location.reload();
    });
    return false;
}

document.getElementById('selectAll').addEventListener('change', function() {
    document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = this.checked);
    document.getElementById('selectAllTop').checked = this.checked;
    updateSelectedCount();
});

document.getElementById('selectAllTop').addEventListener('change', function() {
    document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = this.checked);
    document.getElementById('selectAll').checked = this.checked;
    updateSelectedCount();
});

document.querySelectorAll('.item-checkbox').forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
});

function updateSelectedCount() {
    const count = document.querySelectorAll('.item-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = count;
}

function submitBatchAction(action) {
    const checked = document.querySelectorAll('.item-checkbox:checked');
    if (checked.length === 0) {
        alert('请先选择要操作的记录');
        return;
    }
    
    const confirmMsg = action === 'batch_approve' ? '确定要审批选中的 ' + checked.length + ' 条记录吗？' : '确定要驳回选中的 ' + checked.length + ' 条记录吗？';
    if (!confirm(confirmMsg)) return;
    
    document.getElementById('actionInput').value = action;
    document.getElementById('valveForm').action = "{{ url_for('ledgers.detail', id=ledger.id) }}";
    document.getElementById('valveForm').submit();
}
</script>
{% endblock %}
