{% extends "base.html" %}

{% set page_title_val = ledger.名称 ~ ' - 台账列表' if ledger else '台账列表' %}

{% block page_title %}{{ page_title_val }}{% endblock %}

{% block header_actions %}
{% if ledger %}
<div class="d-flex gap-2">
    {% if from_param == 'mine' %}
    <a href="{{ url_for('valves.my_ledgers') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> 返回
    </a>
    {% else %}
    <a href="{{ url_for('ledgers.list') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> 返回
    </a>
    {% endif %}
    <a href="{{ url_for('ledgers.detail', id=ledger.id, from=from_param) }}" class="btn btn-outline-secondary">
        <i class="bi bi-info-circle"></i> 集合详情
    </a>
</div>
{% else %}
<form method="get" class="d-flex gap-2 flex-wrap" style="align-items: center;">
    <div class="search-box" style="position: relative;">
        <i class="bi bi-search"></i>
        <input type="text" name="search" class="form-control form-control-modern" 
               placeholder="搜索所有字段..." value="{{ request.args.get('search', '') }}"
               style="height: 36px; padding-left: 32px; width: 180px;">
    </div>
    <select name="status" class="form-control form-control-modern" style="width: 110px; height: 36px; font-size: 13px;">
        <option value="">全部状态</option>
        <option value="draft" {% if request.args.get('status')=='draft' %}selected{% endif %}>草稿</option>
        <option value="pending" {% if request.args.get('status')=='pending' %}selected{% endif %}>待审批</option>
        <option value="approved" {% if request.args.get('status')=='approved' %}selected{% endif %}>已审批</option>
        <option value="rejected" {% if request.args.get('status')=='rejected' %}selected{% endif %}>已驳回</option>
    </select>
    <button type="submit" class="btn btn-primary-custom" style="height: 36px; padding: 0 12px;"><i class="bi bi-search"></i></button>
    {% if active_filters %}
    <a href="{{ url_for('valves.list') }}" class="btn btn-outline-secondary" style="height: 36px; padding: 0 10px;"><i class="bi bi-x-lg"></i></a>
    {% endif %}
    <a href="{{ url_for('valves.new') }}" class="btn btn-accent" style="height: 36px; padding: 0 14px; font-size: 13px;"><i class="bi bi-plus-lg"></i> 新增</a>
</form>
{% endif %}
{% endblock %}

{% block content %}
<form method="post" action="{% if ledger %}{{ url_for('ledgers.detail', id=ledger.id) }}{% else %}{{ url_for('valves.batch_delete') }}{% endif %}" id="batchForm">
    <input type="hidden" name="action" id="batchAction" value="">
    <div class="modern-card mb-2">
        <div class="d-flex justify-content-between align-items-center p-2" style="border-bottom: 1px solid var(--border-color);">
            <div class="d-flex align-items-center gap-2">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="selectAll">
                </div>
                <span style="font-size: 13px;">已选 <span id="selectedCount">0</span> 项</span>
                {% if ledger %}
                {% if current_user.role in ['leader', 'admin'] and ledger.status == 'pending' %}
                <button type="button" class="btn btn-sm btn-success" style="padding: 4px 12px; font-size: 12px;" onclick="submitBatchAction('batch_approve')">
                    <i class="bi bi-check-lg"></i> 批量审批
                </button>
                <button type="button" class="btn btn-sm btn-danger" style="padding: 4px 12px; font-size: 12px;" onclick="submitBatchAction('batch_reject')">
                    <i class="bi bi-x-lg"></i> 批量驳回
                </button>
                {% else %}
                <div class="d-flex align-items-center gap-1">
                    <button type="button" class="btn btn-sm btn-outline-danger" style="padding: 4px 12px; font-size: 12px;" onclick="batchDelete()" title="批量删除">
                        <i class="bi bi-trash"></i> 删除
                    </button>
                </div>
                {% endif %}
                {% else %}
                <div class="d-flex align-items-center gap-1">
                    <a href="{{ url_for('valves.new') }}" class="btn btn-sm btn-primary" style="padding: 4px 12px; font-size: 12px;" title="新增台账">
                        <i class="bi bi-plus-lg"></i> 新增
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-danger" style="padding: 4px 12px; font-size: 12px;" onclick="batchDelete()" title="批量删除">
                        <i class="bi bi-trash"></i> 删除
                    </button>
                    <a href="{{ url_for('valves.import_data') }}" class="btn btn-sm btn-outline-secondary" style="padding: 4px 12px; font-size: 12px;" title="导入数据">
                        <i class="bi bi-upload"></i> 导入
                    </a>
                    <a href="{{ url_for('valves.export_data') }}" class="btn btn-sm btn-outline-secondary" style="padding: 4px 12px; font-size: 12px;" title="导出全部">
                        <i class="bi bi-download"></i> 导出
                    </a>
                </div>
                <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-toggle" style="padding: 3px 10px; font-size: 12px;" type="button" data-bs-toggle="dropdown">
                        更多操作
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="batchExport()"><i class="bi bi-download"></i> 导出选中</a></li>
                        {% if current_user.role in ['leader', 'admin'] %}
                        <li><a class="dropdown-item" href="#" onclick="batchApprove()"><i class="bi bi-check-lg"></i> 批量审批</a></li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                {% if active_filters %}
                <span class="text-muted" style="border-left: 1px solid #dee2e6; padding-left: 8px; margin-left: 4px; font-size: 12px;">
                    <i class="bi bi-funnel-fill text-info"></i> 筛选中
                    <a href="{% if ledger %}{{ url_for('ledgers.detail', id=ledger.id) }}{% else %}{{ url_for('valves.list') }}{% endif %}" style="margin-left: 4px; color: var(--text-muted);"><i class="bi bi-x-lg"></i></a>
                </span>
                {% endif %}
            </div>
            {% if ledger and (ledger.created_by == current_user.id or current_user.role in ['leader', 'admin']) %}
            <a href="{{ url_for('ledgers.new_valve', id=ledger.id) }}" class="btn btn-accent" style="height: 36px; padding: 0 14px; font-size: 13px;">
                <i class="bi bi-plus-lg"></i> 新增台账
            </a>
            {% endif %}
        </div>
    </div>

    <div class="modern-card">
        <div class="table-responsive" style="height: calc(100vh - 180px); overflow-y: auto; overflow-x: auto; position: relative;">
            <table class="modern-table table-sm table-bordered" style="min-width: 2000px; border-spacing: 0;">
<thead class="table-light" style="position: sticky; top: 0; z-index: 20;">
                    <tr>
                        <th style="width: 50px; min-width: 50px; vertical-align: middle; position: sticky; left: 0; z-index: 23; background: #f8f9fa; border-right: 1px solid #dee2e6;">
                            <input type="checkbox" class="form-check-input" id="selectAllTop">
                        </th>
                        <th colspan="11" class="text-center table-secondary" style="position: sticky; left: 50px; z-index: 21;">基础信息</th>
                        <th colspan="4" class="text-center table-info" style="position: sticky; z-index: 21;">工艺条件</th>
                        <th colspan="3" class="text-center table-warning" style="position: sticky; z-index: 21;">阀体信息</th>
                        <th colspan="7" class="text-center table-danger" style="position: sticky; z-index: 21;">阀内件信息</th>
                        <th colspan="10" class="text-center table-success" style="position: sticky; z-index: 21;">执行机构信息</th>
                        <th colspan="2" class="text-center" style="position: sticky; right: 0; z-index: 23; background: #f8f9fa;">操作列</th>
                    </tr>
<tr>
                        <th style="width: 50px; min-width: 50px; position: sticky; left: 0; z-index: 22; background: #f8f9fa; border-right: 1px solid #dee2e6; border-bottom: 2px solid #dee2e6;"></th>
                        {% set fields = [
                            ('序号', '序号', 50, 'sticky'), ('位号', '位号', 100, ''), ('名称', '名称', 120, ''), ('装置名称', '装置名称', 100, ''),
                            ('设备等级', '设备等级', 70, ''), ('型号规格', '型号规格', 100, ''), ('生产厂家', '生产厂家', 100, ''),
                            ('安装位置及用途', '安装位置', 120, ''), ('设备编号', '设备编号', 90, ''), ('是否联锁', '是否联锁', 70, ''), ('备注', '备注', 80, ''),
                            ('工艺条件_介质名称', '介质名称', 80, ''), ('工艺条件_设计温度', '设计温度', 80, ''),
                            ('工艺条件_阀前压力', '阀前压力', 80, ''), ('工艺条件_阀后压力', '阀后压力', 80, ''),
                            ('阀体_公称通径', '公称通径', 80, ''), ('阀体_连接方式及规格', '连接方式', 100, ''), ('阀体_材质', '阀体材质', 80, ''),
                            ('阀内件_阀座直径', '阀座直径', 80, ''), ('阀内件_阀芯材质', '阀芯材质', 80, ''),
                            ('阀内件_阀座材质', '阀座材质', 80, ''), ('阀内件_阀杆材质', '阀杆材质', 80, ''),
                            ('阀内件_流量特性', '流量特性', 80, ''), ('阀内件_泄露等级', '泄露等级', 80, ''), ('阀内件_Cv值', 'Cv值', 60, ''),
                            ('执行机构_形式', '形式', 80, ''), ('执行机构_型号规格', '型号规格', 100, ''), ('执行机构_厂家', '厂家', 80, ''),
                            ('执行机构_作用形式', '作用形式', 80, ''), ('执行机构_行程', '行程', 60, ''),
                            ('执行机构_弹簧范围', '弹簧范围', 80, ''), ('执行机构_气源压力', '气源压力', 80, ''),
                            ('执行机构_故障位置', '故障位置', 80, ''), ('执行机构_关阀时间', '关阀时间', 70, ''), ('执行机构_开阀时间', '开阀时间', 70, ''),
                            ('状态', '状态', 100, 'sticky'), ('操作', '操作', 100, 'sticky')
                        ] %}
                        {% for field, label, width, style in fields %}
                        <th {% if style == 'sticky' %}style="min-width: {{ width }}px; position: sticky; right: {{ '100px' if field == '状态' else '0px' }}; z-index: 22; background: #f8f9fa; border-bottom: 2px solid #dee2e6;"{% else %}class="filter-header" data-field="{{ field }}" style="min-width: {{ width }}px; cursor: pointer; position: sticky; top: 50px; z-index: 21; background: #f8f9fa; border-bottom: 2px solid #dee2e6;" onclick="showFilterDropdown(event, '{{ field }}')"{% endif %}>
                            {% if style != 'sticky' %}
                            <div class="d-flex align-items-center justify-content-between">
                                <span>{{ label }}</span>
                                {% if active_filters and field in active_filters %}
                                <i class="bi bi-funnel-fill text-primary ms-1" style="font-size: 10px;"></i>
                                {% else %}
                                <i class="bi bi-funnel ms-1" style="font-size: 10px; opacity: 0.5;"></i>
                                {% endif %}
                            </div>
                            {% else %}
                            {{ label }}
                            {% endif %}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for valve in valves %}
                    <tr>
                        <td style="position: sticky; left: 0; z-index: 2; background: #fff; border-right: 1px solid #dee2e6;"><input type="checkbox" name="ids" value="{{ valve.id }}" class="form-check-input item-checkbox"></td>
                        <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                        <td><a href="{% if ledger %}{{ url_for('ledgers.valve_detail', ledger_id=ledger.id, id=valve.id) }}{% else %}{{ url_for('valves.detail', id=valve.id) }}{% endif %}" style="color: var(--primary-color); font-weight: 500;">{{ valve.位号 }}</a></td>
                        <td>{{ valve.名称 or '-' }}</td>
                        <td>{{ valve.装置名称 or '-' }}</td>
                        <td>{{ valve.设备等级 or '-' }}</td>
                        <td>{{ valve.型号规格 or '-' }}</td>
                        <td>{{ valve.生产厂家 or '-' }}</td>
                        <td>{{ valve.安装位置及用途 or '-' }}</td>
                        <td>{{ valve.设备编号 or '-' }}</td>
                        <td>{{ valve.是否联锁 or '-' }}</td>
                        <td>{{ valve.备注[:10] + '...' if valve.备注 and valve.备注|length > 10 else valve.备注 or '-' }}</td>
                        <td>{{ valve.工艺条件_介质名称 or '-' }}</td>
                        <td>{{ valve.工艺条件_设计温度 or '-' }}</td>
                        <td>{{ valve.工艺条件_阀前压力 or '-' }}</td>
                        <td>{{ valve.工艺条件_阀后压力 or '-' }}</td>
                        <td>{{ valve.阀体_公称通径 or '-' }}</td>
                        <td>{{ valve.阀体_连接方式及规格 or '-' }}</td>
                        <td>{{ valve.阀体_材质 or '-' }}</td>
                        <td>{{ valve.阀内件_阀座直径 or '-' }}</td>
                        <td>{{ valve.阀内件_阀芯材质 or '-' }}</td>
                        <td>{{ valve.阀内件_阀座材质 or '-' }}</td>
                        <td>{{ valve.阀内件_阀杆材质 or '-' }}</td>
                        <td>{{ valve.阀内件_流量特性 or '-' }}</td>
                        <td>{{ valve.阀内件_泄露等级 or '-' }}</td>
                        <td>{{ valve.阀内件_Cv值 or '-' }}</td>
                        <td>{{ valve.执行机构_形式 or '-' }}</td>
                        <td>{{ valve.执行机构_型号规格 or '-' }}</td>
                        <td>{{ valve.执行机构_厂家 or '-' }}</td>
                        <td>{{ valve.执行机构_作用形式 or '-' }}</td>
                        <td>{{ valve.执行机构_行程 or '-' }}</td>
                        <td>{{ valve.执行机构_弹簧范围 or '-' }}</td>
                        <td>{{ valve.执行机构_气源压力 or '-' }}</td>
                        <td>{{ valve.执行机构_故障位置 or '-' }}</td>
                        <td>{{ valve.执行机构_关阀时间 or '-' }}</td>
                        <td>{{ valve.执行机构_开阀时间 or '-' }}</td>
                        <td style="position: sticky; right: 100px; z-index: 2; background: #fff; border-left: 1px solid #dee2e6;">
                            {% if valve.status == 'approved' %}
                            <span class="badge-status badge-approved">已审批</span>
                            {% elif valve.status == 'pending' %}
                            <span class="badge-status badge-pending">待审批</span>
                            {% elif valve.status == 'rejected' %}
                            <span class="badge-status badge-rejected">已驳回</span>
                            {% else %}
                            <span class="badge-status badge-draft">草稿</span>
                            {% endif %}
                        </td>
                        <td style="position: sticky; right: 0; z-index: 2; background: #fff;">
                            <a href="{% if ledger %}{{ url_for('ledgers.valve_detail', ledger_id=ledger.id, id=valve.id) }}{% else %}{{ url_for('valves.detail', id=valve.id) }}{% endif %}" class="btn-action" style="background: #e2e8f0; color: #475569;"><i class="bi bi-eye"></i></a>
                            {% if (ledger and (ledger.created_by == current_user.id or current_user.role in ['leader', 'admin']) and valve.status in ['draft', 'rejected', 'approved']) or (not ledger and (valve.created_by == current_user.id or current_user.role in ['leader', 'admin'])) %}
                            <a href="{% if ledger %}{{ url_for('ledgers.edit_valve', ledger_id=ledger.id, id=valve.id) }}{% else %}{{ url_for('valves.edit', id=valve.id) }}{% endif %}" class="btn-action" style="background: rgba(56,178,172,0.1); color: var(--accent-color);"><i class="bi bi-pencil"></i></a>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="38">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>暂无台账数据</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if pagination %}
        <div class="d-flex justify-content-between align-items-center p-2" style="border-top: 1px solid var(--border-color);">
            <small class="text-muted">共 {{ pagination.total }} 条记录，第 {{ pagination.page }}/{{ pagination.pages }} 页</small>
            <nav>
                <ul class="pagination-custom pagination mb-0" style="gap: 4px;">
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" style="padding: 4px 10px;" href="{% if ledger %}{{ url_for('ledgers.detail', id=ledger.id, page=pagination.prev_num) }}{% else %}{{ url_for('valves.list', page=pagination.prev_num) }}{% endif %}">
                            <i class="bi bi-chevron-left"></i> 上一页
                        </a>
                    </li>
                    {% endif %}
                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" style="padding: 4px 10px;" href="{% if ledger %}{{ url_for('ledgers.detail', id=ledger.id, page=pagination.next_num) }}{% else %}{{ url_for('valves.list', page=pagination.next_num) }}{% endif %}">
                            下一页 <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</form>

<script>
document.getElementById('selectAll').addEventListener('change', function() {
    document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = this.checked);
    document.getElementById('selectAllTop').checked = this.checked;
    updateSelectedCount();
});

document.getElementById('selectAllTop').addEventListener('change', function() {
    document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = this.checked);
    document.getElementById('selectAll').checked = this.checked;
    updateSelectedCount();
});

document.querySelectorAll('.item-checkbox').forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
});

function updateSelectedCount() {
    const count = document.querySelectorAll('.item-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = count;
}

function batchDelete() {
    const checked = document.querySelectorAll('.item-checkbox:checked');
    if (checked.length === 0) { alert('请先选择要删除的记录'); return; }
    if (confirm('确定要删除选中的 ' + checked.length + ' 条记录吗？')) {
        document.getElementById('batchForm').action = "{{ url_for('valves.batch_delete') }}";
        document.getElementById('batchForm').submit();
    }
}

function batchExport() {
    const checked = document.querySelectorAll('.item-checkbox:checked');
    if (checked.length === 0) { alert('请先选择要导出的记录'); return; }
    const ids = Array.from(checked).map(cb => cb.value);
    window.location.href = "{{ url_for('valves.export_data') }}?" + ids.map(id => 'ids=' + id).join('&');
}

function batchApprove() {
    const checked = document.querySelectorAll('.item-checkbox:checked');
    if (checked.length === 0) { alert('请先选择要审批的记录'); return; }
    if (confirm('确定要审批选中的 ' + checked.length + ' 条记录吗？')) {
        document.getElementById('batchForm').action = "{{ url_for('valves.batch_approve') }}";
        document.getElementById('batchForm').submit();
    }
}

let currentFilterDropdown = null;

function showFilterDropdown(event, field) {
    event.stopPropagation();
    
    const existingDropdown = document.getElementById('filterDropdown');
    if (existingDropdown) {
        existingDropdown.remove();
    }
    
    const filterOptions = {{ filter_options | tojson | safe }};
    const activeFilters = {{ active_filters | tojson | safe }};
    
    if (!filterOptions[field] || filterOptions[field].length === 0) {
        return;
    }
    
    const dropdown = document.createElement('div');
    dropdown.id = 'filterDropdown';
    dropdown.className = 'filter-dropdown';
    dropdown.style.cssText = 'position: absolute; z-index: 9999; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); min-width: 240px; max-width: 320px;';
    
    const rect = event.target.getBoundingClientRect();
    dropdown.style.left = rect.left + 'px';
    dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
    
    let html = `<div class="p-3 border-bottom d-flex justify-content-between align-items-center" style="background: #f8fafc; border-radius: 8px 8px 0 0;">
        <strong style="color: #1e293b; font-size: 14px;">筛选 ${event.target.textContent}</strong>
        <button type="button" class="btn-close btn-sm" onclick="this.closest('#filterDropdown').remove()" style="opacity: 0.5;"></button>
    </div>
    <div class="p-3 pb-2">
        <div class="form-check mb-2 d-flex align-items-center">
            <input type="checkbox" class="form-check-input" id="selectAll_${field}" onchange="toggleAllFilter('${field}', this.checked)" style="width: 16px; height: 16px; margin-right: 8px;">
            <label class="form-check-label" for="selectAll_${field}" style="font-size: 13px; color: #475569;">全选</label>
        </div>
        <div class="filter-options" style="max-height: 280px; overflow-y: auto; padding-right: 4px;">`;
    
    const selectedValues = activeFilters[field] || [];
    
    filterOptions[field].forEach(value => {
        const isChecked = selectedValues.includes(value);
        html += `<div class="form-check d-flex align-items-center py-1" style="min-height: 32px;">
            <input type="checkbox" class="form-check-input filter-option" name="${field}" value="${value}" ${isChecked ? 'checked' : ''} style="width: 16px; height: 16px; margin-right: 8px;">
            <label class="form-check-label" style="word-break: break-all; font-size: 13px; color: #334155;">${value}</label>
        </div>`;
    });
    
    html += `</div></div>
    <div class="p-3 border-top d-flex gap-2" style="border-radius: 0 0 8px 8px; background: #f8fafc;">
        <button class="btn btn-sm flex-grow-1" onclick="clearFilter('${field}')" style="background: #fff; border: 1px solid #e2e8f0; color: #475569; font-size: 13px; padding: 6px 12px;">清除</button>
        <button class="btn btn-sm flex-grow-1" onclick="applyFilter('${field}')" style="background: linear-gradient(135deg, #38b2ac 0%, #2dd4bf 100%); border: none; color: white; font-size: 13px; padding: 6px 12px;">应用</button>
    </div>`;
    
    dropdown.innerHTML = html;
    document.body.appendChild(dropdown);
    
    currentFilterDropdown = dropdown;
    
    document.addEventListener('click', function closeDropdown(e) {
        if (!dropdown.contains(e.target) && !e.target.closest('.filter-header')) {
            dropdown.remove();
            document.removeEventListener('click', closeDropdown);
        }
    });
}

function toggleAllFilter(field, checked) {
    document.querySelectorAll(`.filter-option[name="${field}"]`).forEach(cb => {
        cb.checked = checked;
    });
}

function applyFilter(field) {
    const checked = document.querySelectorAll(`.filter-option[name="${field}"]:checked`);
    const values = Array.from(checked).map(cb => cb.value);
    
    const url = new URL(window.location.href);
    
    const existingParams = url.searchParams.getAll(field);
    existingParams.forEach(() => url.searchParams.delete(field));
    
    values.forEach(v => url.searchParams.append(field, v));
    
    window.location.href = url.toString();
}

function clearFilter(field) {
    const url = new URL(window.location.href);
    url.searchParams.delete(field);
    window.location.href = url.toString();
}

function submitBatchAction(action) {
    const checked = document.querySelectorAll('.item-checkbox:checked');
    if (checked.length === 0) {
        alert('请先选择要操作的记录');
        return;
    }
    
    const confirmMsg = action === 'batch_approve' ? '确定要审批选中的 ' + checked.length + ' 条记录吗？' : '确定要驳回选中的 ' + checked.length + ' 条记录吗？';
    if (!confirm(confirmMsg)) return;
    
    document.getElementById('batchAction').value = action;
    document.getElementById('batchForm').submit();
}
</script>
{% endblock %}
