{% extends "base.html" %}

{% block page_title %}台账列表{% endblock %}

{% block header_actions %}
<form method="get" class="d-flex gap-2">
    <div class="search-box">
        <i class="bi bi-search"></i>
        <input type="text" name="search" class="form-control form-control-modern" placeholder="搜索位号/名称/装置..." value="{{ request.args.get('search', '') }}">
    </div>
    <button type="submit" class="btn btn-primary-custom"><i class="bi bi-search"></i></button>
    <a href="{{ url_for('valves.new') }}" class="btn btn-accent"><i class="bi bi-plus-lg"></i> 新增</a>
</form>
{% endblock %}

{% block content %}
<form method="post" action="{{ url_for('valves.batch_delete') }}" id="batchForm">
    <div class="modern-card">
        <div class="d-flex justify-content-between align-items-center p-3" style="border-bottom: 1px solid var(--border-color);">
            <div class="d-flex align-items-center gap-3">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="selectAll">
                </div>
                <button type="button" class="btn btn-sm btn-danger" onclick="batchDelete()">
                    <i class="bi bi-trash"></i> 批量删除
                </button>
            </div>
            <span style="color: var(--text-muted); font-size: 14px;">共 {{ valves|length }} 条记录</span>
        </div>
        
        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>序号</th>
                        <th>位号</th>
                        <th>名称</th>
                        <th>装置名称</th>
                        <th>设备等级</th>
                        <th>状态</th>
                        <th style="width: 160px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for valve in valves %}
                    <tr>
                        <td><input type="checkbox" name="ids" value="{{ valve.id }}" class="form-check-input"></td>
                        <td>{{ valve.序号 }}</td>
                        <td><a href="{{ url_for('valves.detail', id=valve.id) }}" style="color: var(--primary-color); font-weight: 500;">{{ valve.位号 }}</a></td>
                        <td>{{ valve.名称 }}</td>
                        <td>{{ valve.装置名称 }}</td>
                        <td>{{ valve.设备等级 }}</td>
                        <td>
                            {% if valve.status == 'approved' %}
                            <span class="badge-status badge-approved">已审批</span>
                            {% elif valve.status == 'pending' %}
                            <span class="badge-status badge-pending">待审批</span>
                            {% elif valve.status == 'rejected' %}
                            <span class="badge-status badge-rejected">已驳回</span>
                            {% else %}
                            <span class="badge-status badge-draft">草稿</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('valves.detail', id=valve.id) }}" class="btn-action" style="background: #e2e8f0; color: #475569;"><i class="bi bi-eye"></i> 查看</a>
                            {% if valve.created_by == current_user.id or current_user.role in ['leader', 'admin'] %}
                            <a href="{{ url_for('valves.edit', id=valve.id) }}" class="btn-action" style="background: rgba(56,178,172,0.1); color: var(--accent-color);"><i class="bi bi-pencil"></i> 编辑</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>暂无台账数据</p>
                                <a href="{{ url_for('valves.new') }}" class="btn btn-primary-custom mt-2">新增台账</a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</form>

<script>
document.getElementById('selectAll').addEventListener('change', function() {
    document.querySelectorAll('input[name="ids"]').forEach(cb => cb.checked = this.checked);
});

function batchDelete() {
    const checked = document.querySelectorAll('input[name="ids"]:checked');
    if (checked.length === 0) {
        alert('请先选择要删除的记录');
        return;
    }
    if (confirm('确定要删除选中的 ' + checked.length + ' 条记录吗？')) {
        document.getElementById('batchForm').submit();
    }
}
</script>
{% endblock %}
