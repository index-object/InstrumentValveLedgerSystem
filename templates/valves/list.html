{% extends "base.html" %}

{% block title %}台账列表{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>台账列表</h2>
    <div>
        <form method="get" class="d-flex">
            <input type="text" name="search" class="form-control me-2" placeholder="搜索位号/名称/装置..." value="{{ request.args.get('search', '') }}">
            <button type="submit" class="btn btn-outline-primary">搜索</button>
        </form>
    </div>
</div>

<form method="post" action="{{ url_for('valves.batch_delete') }}" id="batchForm">
    <div class="mb-2">
        <button type="button" class="btn btn-sm btn-danger" onclick="batchDelete()">批量删除</button>
    </div>
    
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>序号</th>
                    <th>位号</th>
                    <th>名称</th>
                    <th>装置名称</th>
                    <th>设备等级</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for valve in valves %}
                <tr>
                    <td><input type="checkbox" name="ids" value="{{ valve.id }}"></td>
                    <td>{{ valve.序号 }}</td>
                    <td><a href="{{ url_for('valves.detail', id=valve.id) }}">{{ valve.位号 }}</a></td>
                    <td>{{ valve.名称 }}</td>
                    <td>{{ valve.装置名称 }}</td>
                    <td>{{ valve.设备等级 }}</td>
                    <td>
                        {% if valve.status == 'approved' %}
                        <span class="badge bg-success">已审批</span>
                        {% elif valve.status == 'pending' %}
                        <span class="badge bg-warning">待审批</span>
                        {% elif valve.status == 'rejected' %}
                        <span class="badge bg-danger">已驳回</span>
                        {% else %}
                        <span class="badge bg-secondary">草稿</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('valves.detail', id=valve.id) }}" class="btn btn-sm btn-info">查看</a>
                        {% if valve.created_by == current_user.id or current_user.role in ['leader', 'admin'] %}
                        <a href="{{ url_for('valves.edit', id=valve.id) }}" class="btn btn-sm btn-primary">编辑</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>

<script>
document.getElementById('selectAll').addEventListener('change', function() {
    document.querySelectorAll('input[name="ids"]').forEach(cb => cb.checked = this.checked);
});

function batchDelete() {
    if (confirm('确定要删除选中的记录吗？')) {
        document.getElementById('batchForm').submit();
    }
}
</script>
{% endblock %}
