{% extends "base.html" %}

{% block page_title %}台账详情{% endblock %}

{% block header_actions %}
<div class="d-flex gap-2">
    {% if valve.created_by == current_user.id or current_user.role in ['leader', 'admin'] %}
    <a href="{{ url_for('valves.edit', id=valve.id) }}" class="btn btn-primary-custom"><i class="bi bi-pencil"></i> 编辑</a>
    {% endif %}
    <a href="{{ url_for('valves.list') }}" class="btn" style="background: #e2e8f0; color: #475569;"><i class="bi bi-arrow-left"></i> 返回</a>
</div>
{% endblock %}

{% block content %}
<div class="modern-card mb-4">
    <div class="p-4" style="border-bottom: 1px solid var(--border-color);">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 style="font-weight: 600; margin-bottom: 8px;">{{ valve.位号 }} - {{ valve.名称 }}</h3>
                <span class="text-muted">装置: {{ valve.装置名称 }}</span>
            </div>
            <div>
                {% if valve.status == 'approved' %}
                <span class="badge-status badge-approved">已审批</span>
                {% elif valve.status == 'pending' %}
                <span class="badge-status badge-pending">待审批</span>
                {% elif valve.status == 'rejected' %}
                <span class="badge-status badge-rejected">已驳回</span>
                {% else %}
                <span class="badge-status badge-draft">草稿</span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="card-body-custom">
        <div class="detail-section mb-4">
            <h5 class="detail-title"><i class="bi bi-info-circle"></i> 基础信息</h5>
            <div class="detail-grid">
                <div class="detail-item"><span class="detail-label">序号</span><span class="detail-value">{{ valve.序号 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">位号</span><span class="detail-value">{{ valve.位号 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">名称</span><span class="detail-value">{{ valve.名称 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">装置名称</span><span class="detail-value">{{ valve.装置名称 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">设备等级</span><span class="detail-value">{{ valve.设备等级 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">型号规格</span><span class="detail-value">{{ valve.型号规格 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">生产厂家</span><span class="detail-value">{{ valve.生产厂家 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">安装位置</span><span class="detail-value">{{ valve.安装位置及用途 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">设备编号</span><span class="detail-value">{{ valve.设备编号 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">是否联锁</span><span class="detail-value">{{ valve.是否联锁 or '-' }}</span></div>
            </div>
        </div>
        
        <div class="detail-section mb-4">
            <h5 class="detail-title"><i class="bi bi-gear"></i> 工艺条件</h5>
            <div class="detail-grid">
                <div class="detail-item"><span class="detail-label">介质名称</span><span class="detail-value">{{ valve.工艺条件_介质名称 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">设计温度</span><span class="detail-value">{{ valve.工艺条件_设计温度 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">阀前压力</span><span class="detail-value">{{ valve.工艺条件_阀前压力 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">阀后压力</span><span class="detail-value">{{ valve.工艺条件_阀后压力 or '-' }}</span></div>
            </div>
        </div>
        
        <div class="detail-section mb-4">
            <h5 class="detail-title"><i class="bi bi-box"></i> 阀体信息</h5>
            <div class="detail-grid">
                <div class="detail-item"><span class="detail-label">公称通径</span><span class="detail-value">{{ valve.阀体_公称通径 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">连接方式</span><span class="detail-value">{{ valve.阀体_连接方式及规格 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">材质</span><span class="detail-value">{{ valve.阀体_材质 or '-' }}</span></div>
            </div>
        </div>
        
        <div class="detail-section mb-4">
            <h5 class="detail-title"><i class="bi bi-sliders"></i> 阀内件信息</h5>
            <div class="detail-grid">
                <div class="detail-item"><span class="detail-label">阀座直径</span><span class="detail-value">{{ valve.阀内件_阀座直径 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">阀芯材质</span><span class="detail-value">{{ valve.阀内件_阀芯材质 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">阀座材质</span><span class="detail-value">{{ valve.阀内件_阀座材质 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">阀杆材质</span><span class="detail-value">{{ valve.阀内件_阀杆材质 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">流量特性</span><span class="detail-value">{{ valve.阀内件_流量特性 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">泄露等级</span><span class="detail-value">{{ valve.阀内件_泄露等级 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">Cv值</span><span class="detail-value">{{ valve.阀内件_Cv值 or '-' }}</span></div>
            </div>
        </div>
        
        <div class="detail-section mb-4">
            <h5 class="detail-title"><i class="bi bi-lightning"></i> 执行机构信息</h5>
            <div class="detail-grid">
                <div class="detail-item"><span class="detail-label">形式</span><span class="detail-value">{{ valve.执行机构_形式 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">型号规格</span><span class="detail-value">{{ valve.执行机构_型号规格 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">厂家</span><span class="detail-value">{{ valve.执行机构_厂家 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">作用形式</span><span class="detail-value">{{ valve.执行机构_作用形式 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">行程</span><span class="detail-value">{{ valve.执行机构_行程 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">弹簧范围</span><span class="detail-value">{{ valve.执行机构_弹簧范围 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">气源压力</span><span class="detail-value">{{ valve.执行机构_气源压力 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">故障位置</span><span class="detail-value">{{ valve.执行机构_故障位置 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">关阀时间</span><span class="detail-value">{{ valve.执行机构_关阀时间 or '-' }}</span></div>
                <div class="detail-item"><span class="detail-label">开阀时间</span><span class="detail-value">{{ valve.执行机构_开阀时间 or '-' }}</span></div>
            </div>
        </div>
        
        {% if valve.备注 %}
        <div class="detail-section">
            <h5 class="detail-title"><i class="bi bi-chat-left-text"></i> 备注</h5>
            <p style="color: var(--text-dark);">{{ valve.备注 }}</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="modern-card mb-4">
    <div class="card-header-custom"><i class="bi bi-paperclip"></i> 附件信息</div>
    <div class="card-body-custom">
        <div class="row g-3">
            {% if valve.attachments %}
                {% for att in valve.attachments %}
                <div class="col-md-3">
                    <div class="p-3" style="border: 1px solid var(--border-color); border-radius: 8px;">
                        <h6 class="mb-2"><i class="bi bi-gear"></i> {{ att.名称 or att.type }}</h6>
                        <p class="small text-muted mb-1">类型: {{ att.type or '-' }}</p>
                        <p class="small text-muted mb-1">型号: {{ att.型号规格 or '-' }}</p>
                        <p class="small text-muted mb-0">厂家: {{ att.生产厂家 or '-' }}</p>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="col-12">
                <p class="text-muted">暂无附件信息</p>
            </div>
            {% endif %}
        </div>
        {% if valve.created_by == current_user.id or current_user.role in ['leader', 'admin'] %}
        <a href="{{ url_for('valves.attachments', id=valve.id) }}" class="btn btn-sm btn-outline-primary mt-3">
            <i class="bi bi-plus"></i> 管理附件
        </a>
        {% endif %}
    </div>
</div>

<div class="modern-card mb-4">
    <div class="card-header-custom"><i class="bi bi-camera"></i> 照片</div>
    <div class="card-body-custom">
        <div class="row g-3">
            {% if valve.photos %}
                {% for photo in valve.photos %}
                <div class="col-md-2">
                    <a href="{{ url_for('static', filename='uploads/' + photo.filename) }}" target="_blank">
                        <img src="{{ url_for('static', filename='uploads/' + photo.filename) }}" 
                             class="img-thumbnail" style="height: 100px; width: 100%; object-fit: cover; border-radius: 8px;">
                    </a>
                    <small class="d-block text-muted mt-1">{{ photo.description or '无描述' }}</small>
                </div>
                {% endfor %}
            {% else %}
            <div class="col-12">
                <p class="text-muted">暂无照片</p>
            </div>
            {% endif %}
        </div>
        <a href="{{ url_for('valves.photos', id=valve.id) }}" class="btn btn-sm btn-outline-primary mt-3">
            <i class="bi bi-plus"></i> 管理照片
        </a>
    </div>
</div>

<div class="modern-card mb-4">
    <div class="card-header-custom"><i class="bi bi-wrench"></i> 维护记录</div>
    <div class="card-body-custom">
        <a href="{{ url_for('valves.maintenance', id=valve.id) }}" class="btn btn-sm btn-primary mb-3">
            <i class="bi bi-plus"></i> 添加维护记录
        </a>
        {% if valve.maintenance_records %}
        <table class="modern-table">
            <thead>
                <tr>
                    <th>所属中心</th>
                    <th>检修时间</th>
                    <th>检修人员</th>
                    <th>检修内容</th>
                </tr>
            </thead>
            <tbody>
                {% for record in valve.maintenance_records[:5] %}
                <tr>
                    <td>{{ record.所属中心 or '-' }}</td>
                    <td>{{ record.检修时间.strftime('%Y-%m-%d %H:%M') if record.检修时间 else '-' }}</td>
                    <td>{{ record.检修人员 or '-' }}</td>
                    <td>{{ record.检修内容[:30] if record.检修内容 else '-' }}{% if record.检修内容 and record.检修内容|length > 30 %}...{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if valve.maintenance_records|length > 5 %}
        <a href="{{ url_for('valves.maintenance_list') }}?valve_id={{ valve.id }}" class="btn btn-sm btn-link mt-2">查看全部维护记录</a>
        {% endif %}
        {% else %}
        <p class="text-muted">暂无维护记录</p>
        {% endif %}
    </div>
</div>

<style>
.detail-section { }
.detail-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--accent-color);
    display: flex;
    align-items: center;
    gap: 8px;
}
.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
}
.detail-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.detail-label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.detail-value {
    font-size: 14px;
    color: var(--text-dark);
    font-weight: 500;
}
</style>
{% endblock %}
